<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LED Setup</title>
<!-- Tabulator CDN -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.7.1/css/tabulator_simple.min.css" rel="stylesheet">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.7.1/js/tabulator.min.js"></script>
<!-- flatpickr CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- moment.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
<script src="index.js"></script>
<style>
  .tabulator-col-title {text-align: center;}
  .container {display: flex; width:auto; justify-content: space-evenly; padding-left:5%; padding-right:5%}
  #timerTable {width:40%; margin-right:5%}
  #channelTable {width:60%}
  #scheduleTable {width: 100%;}
  html {font-family: sans-serif;}  
</style>
</head>
<body>
<div class="container">
<div id="timerTable"></div><div id="channelTable"></div>
</div>
<br/>
<div class="container"></div>
<button onclick="scheduleTable.addRow()">Add Time</button>
<button onclick="save()">Save</button>
<span id="status"></span>
</div>
<br/>
<div class="container">
<div id="scheduleTable"></div>
</div>
<script type="text/javascript">

// Define the system config table
var timerTable = new Tabulator("#timerTable", {
  headerSort: false, // Don't allow sorting
  reactiveData: true, // Update data source as table is editted
  data: Timers.all,
  layout: "fitColumns",
  columns: [
    { title: "Timer", field: "name", widthGrow:3, },
    { title: "Frequency", field: "freq", widthGrow:2, editor: "number", 
      editorParams: {
        min: 0, 
        max: 50000, 
        step:1000, 
        mask: "99999",
      },
      validator:"max:50000",
      tooltip: (c) => !c.isValid() ? "Frequency value must be between 0 Hz and 50 kHz." : "",
    },
  ],
  validationMode: "highlight",
  tooltipGenerationMode: "hover",
});

// Define the channel table
var channelTable = new Tabulator("#channelTable", {
  headerSort: false, // Don't allow sorting
  reactiveData: true, // Update data source as table is editted
  data: Channels.all,
  layout: "fitColumns",
  columns: [
    { title: "ID", field: "id"},
    { title: "Name", field: "name", widthGrow:3, editor: "input", },
    { title: "Timer", field: "timer", widthGrow:2, editor: "select", 
      editorParams:{ 
        values:() => Timers.select_list,
        listItemFormatter:(v,t) => Timers.get_name(v),
      }, 
      formatter: (c, p, o) => Timers.get_name(c.getValue()),
    },
    { title: "GPIO", field: "gpio", editor: "number", editorParams: { min: 0, max: 31, mask: "99" }, validator: ["unique", "max:31"], 
        cellEdited: (c) => { if (!c.getData().valid) c.getRow().getCell("enabled").setValue(false) },
        tooltip: (c) => !c.isValid() ? "GPIO value must be unique and between 0-31" : "",
    },
    { title: "Enabled", field: "enabled", formatter: "tickCross", hozAlign: "center",
        cellClick: (e, c) => { if (c.getData().valid) c.setValue(!c.getValue()) },
        tooltip: (c) => !c.getData().valid ? "GPIO must be assigned to enable channel." : "",
    }
  ],
  dataEdited: () => scheduleTable.setColumns(columnTemplate.concat(Channels.columns)), // Trigger schedule column update whenever this table is changed
  validationMode: "highlight",
  tooltipGenerationMode: "hover",
});

// Template for first 2 columns of schedule table
var columnTemplate = [
  { title: "Remove", formatter: "buttonCross", hozAlign: "center", cellClick: (e, cell) => cell.getRow().delete() },
  { title: "Time Of Day", field: "tod", editor: timeEditor, headerSort: true, sorter: "time", validator: ["unique", "required"],
    cellEdited: (c) => c.getColumn().validate(),
    tooltip: (c) => !c.isValid() ? "Time Of Day must be set and unique." : "",
    sorterParams: {
      format: "HH:mm",
      alignEmptyValues: "bottom",
    }
  },
];

var scheduleTable = new Tabulator("#scheduleTable", {
  headerSort: false,
  // reactiveData doesn't appears to work if columns are variable
  //reactiveData: true,
  data: Schedule.data,
  layout:"fitDataFill",
  columns: columnTemplate,
  validationMode: "highlight",
  tooltipGenerationMode: "hover",
  movableRows: true,
});

window.onload = () => load();
</script>
</body>
</html>